# Dependency Management

Apollos AI uses [uv](https://docs.astral.sh/uv/) for dependency management with `pyproject.toml` as the single source of truth. All commands should be run via [mise](https://mise.jdx.dev/) tasks.

## File Roles

| File | Role | Edit manually? |
|------|------|----------------|
| `pyproject.toml` | All dependencies, project metadata, tool config | Yes |
| `uv.lock` | Reproducible lockfile (committed) | No — generated by `uv lock` |
| `requirements.txt` | Flat pin file for Docker `uv pip install` | No — generated by `uv export` |
| `overrides.txt` | Docker override pins (mirrors `[tool.uv]` overrides) | Yes — keep in sync with pyproject.toml |
| `.python-version` | Python version for uv and mise | Rarely |

## Ongoing Workflow

### Add a new dependency

```bash
mise run deps:add <package>     # adds to pyproject.toml + re-locks + regenerates requirements.txt
```

### Add a dev-only dependency

```bash
mise run deps:add-dev <package>  # adds to dev group + re-locks + regenerates requirements.txt
```

### Remove a dependency

```bash
mise run deps:remove <package>   # removes from pyproject.toml + re-locks + regenerates requirements.txt
```

### Update a dependency version

Edit the version in `pyproject.toml`, then:

```bash
mise run deps:lock               # update uv.lock
mise run deps:export             # regenerate requirements.txt
```

### Install locally (after cloning or pulling)

```bash
mise run install                 # production + dev deps (uv sync --group dev)
# Or for production only:
mise run install:prod            # production deps only (uv sync)
```

### Run tests

```bash
mise run t                       # run test suite
mise run ci                      # full CI: lint + format check + test
```

## Override Dependencies

`browser-use==0.5.11` pins `openai==1.99.2` transitively, but `litellm` needs `>=1.99.5`. Rather than a two-file install hack, we use uv's override mechanism in `pyproject.toml`:

```toml
[tool.uv]
override-dependencies = ["openai==1.99.5"]
```

This tells uv to ignore any transitive pin on `openai` and resolve to exactly `1.99.5`.

> [!IMPORTANT]
> When you add or change an override in `pyproject.toml`, also update `overrides.txt` to keep Docker builds in sync. The `overrides.txt` file is used by Docker's `uv pip install` which doesn't read `pyproject.toml` overrides.

## Docker Compatibility

Docker images use `uv pip install -r requirements.txt --overrides overrides.txt` (see `docker/run/fs/ins/install_A0.sh`). The `overrides.txt` file mirrors the `[tool.uv] override-dependencies` from `pyproject.toml`.

Since `requirements.txt` is generated from the lockfile with all transitive deps fully pinned, Docker builds are reproducible and don't need `pyproject.toml` or `uv.lock`.

## Upstream Merge Strategy

This repo is a fork of [agent0ai/agent-zero](https://github.com/agent0ai/agent-zero), maintained at [jrmatherly/apollos-ai](https://github.com/jrmatherly/apollos-ai). The upstream project still uses a plain `requirements.txt`. When merging upstream changes:

1. **Accept their `requirements.txt` changes** — let git take upstream's version (it will be overwritten).
2. **Update `pyproject.toml`** — add any new packages or version changes from their `requirements.txt` into the `[project] dependencies` list.
3. **Re-lock and re-export**:

```bash
mise run deps:lock
mise run deps:export
```

4. **Verify** — check that new packages resolved correctly:

```bash
mise run deps:verify <new_package>
mise run t
```

This keeps our fork's `pyproject.toml` as the source of truth while staying compatible with upstream's dependency additions.
