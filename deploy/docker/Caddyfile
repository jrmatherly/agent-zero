# Apollos AI — Caddy Reverse Proxy Configuration
#
# TLS MODE 1: Custom Certificates (default)
#   Place cert.pem and key.pem in certs/. Set DOMAIN in .env.
#
# TLS MODE 2: Automatic HTTPS (Let's Encrypt)
#   Comment out the "tls" line. Requires public FQDN + ports 80/443.
#
# TLS MODE 3: Self-signed HTTPS (local dev with HTTPS)
#   Change the tls line to: tls internal
#
# TLS MODE 4: HTTP-only (local dev without TLS)
#   Comment out the HTTPS site address, uncomment the HTTP one.
#   Comment out the tls line.
#
# To switch modes, activate exactly one site address and at most one tls line.
# setup.sh --proxy automates this selection.

# Site address — exactly one must be uncommented:
{$DOMAIN:localhost} {
# http://{$DOMAIN:localhost} {

	# TLS — at most one active (none = Let's Encrypt / HTTP-only):
	tls /etc/caddy/certs/cert.pem /etc/caddy/certs/key.pem
	# tls internal

	reverse_proxy apollos-ai:80 {
		# WebSocket support for Socket.IO
		# Note: Caddy automatically sets X-Forwarded-For, X-Forwarded-Proto,
		# and X-Forwarded-Host. We explicitly set X-Real-IP for app logging.
		header_up X-Real-IP {remote_host}

		# Flush immediately for streaming responses
		flush_interval -1
	}

	# Security headers
	# Note: HSTS is harmless over HTTP (browsers ignore it per RFC 6797).
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Content-Type-Options nosniff
		X-Frame-Options SAMEORIGIN
		Referrer-Policy strict-origin-when-cross-origin
		Permissions-Policy "camera=(), microphone=(), geolocation=()"
		-Server
	}

	# Gzip compression
	encode gzip
}
